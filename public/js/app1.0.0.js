!function(){"use strict";angular.module("unicerApp",["MapModule","LegendsModule","MapInteractionsModule"]).constant("CONFIG",{ENVIRONMENT:"Development",URL_WMS:{Development:"http://localhost:3000/geoserver/wms",Production:"http://gistree.espigueiro.pt:3001/geoserver"},URL_WFS:{Development:"http://localhost:3000/geoserver/wfs",Production:"http://gistree.espigueiro.pt:3001/geoserver"},URL_PRINT:{Development:"http://localhost:3000/geoserver/pdf",Production:"http://gistree.espigueiro.pt:3001/geoserver"}})}(),function(){"use strict";angular.module("LegendsModule",[])}(),function(){"use strict";angular.module("MapModule",[])}(),function(){"use strict";angular.module("MapInteractionsModule",["ui.select","ngSanitize"])}(),function(){"use strict";function e(e){function t(e,t){return e.findIndex(function(e){return e.title==this.title},t)}function n(e,t){e.splice(t,1)}this.groups=[],this.addLayerLegend=function(n){var o=t(this.groups,n.parent);o>-1?-1==t(this.groups[o].data,n)&&this.groups[o].data.push({title:n.title,url:e.URL_WMS[e.ENVIRONMENT]+"?REQUEST=GetLegendGraphic&VERSION=1.1.1&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER="+n.data.workspace+":"+n.data.name+"&LEGEND_OPTIONS=forceLabels:on;fontSize:11&SCALE=1000000"}):(this.groups.push({title:n.parent.title,data:[]}),this.groups[this.groups.length-1].data.push({title:n.title,url:e.URL_WMS[e.ENVIRONMENT]+"?REQUEST=GetLegendGraphic&VERSION=1.1.1&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER="+n.data.workspace+":"+n.data.name+"&LEGEND_OPTIONS=forceLabels:on;fontSize:11&SCALE=1000000"}))}.bind(this),this.removeLayerLegend=function(e){var o=t(this.groups,e.parent),r=t(this.groups[o].data,e);n(this.groups[o].data,r),0==this.groups[o].data.length&&n(this.groups,o)}.bind(this)}angular.module("LegendsModule").service("LegendsService",e),e.$inject=["CONFIG"]}(),function(){"use strict";function e(){return{bindToController:!0,controller:t,controllerAs:"lgCtrl",restrict:"A",scope:{title:"@"},transclude:!0,templateUrl:"views/templates/legend.html"}}function t(){}angular.module("LegendsModule").directive("legend",e)}(),function(){"use strict";function e(){return{bindToController:!0,controller:t,controllerAs:"lgCtrl",restrict:"E",scope:{},templateUrl:"views/templates/legends.html"}}function t(e){this.groups=e.groups}angular.module("LegendsModule").directive("legendsGroup",e),t.$inject=["LegendsService"]}(),function(){"use strict";function e(e,t){var n=this;!function(){n.baseLayers=[{name:"Open Street Map",layerDef:new ol.layer.Tile({source:new ol.source.OSM({})})},{name:"Camada em Branco",layerDef:new ol.layer.Tile({})}],n.baseLayer="Mapa de Base"}(),n.setBaseLayer=function(e){n.baseLayer=e.name,t.setBaseLayer(e.layerDef)}}angular.module("MapModule").controller("BaseLayerController",e),e.$inject=["$scope","MapService"]}(),function(){"use strict";function e(e){var t=this;e.groups=[],t.expandTree=function(){e.tree.visit(function(e){e.setExpanded(!0)})},t.collapseTree=function(){e.tree.visit(function(e){e.setExpanded(!1)})},t.deselectAll=function(){e.tree.visit(function(e){e.setSelected(!1)})},t.hideMenu=function(){e.$parent.menuIsHidden=!0},t.help=function(){alert(" Em Desenvolvimento... ")}}angular.module("MapModule").controller("TabsController",e),e.$inject=["$scope"]}(),function(){"use strict";function e(e,t,n,o){function r(r,a,i){a.find("#tree").fancytree({extensions:["edit","glyph","wide"],checkbox:!0,glyph:t.glyph_opts,clickFolderMode:4,selectMode:3,source:{url:"/layers"},toggleEffect:{effect:"drop",options:{direction:"left"},duration:200},wide:{iconWidth:"1em",iconSpacing:"0.5em",levelOfs:"1.5em",labelSpacing:"0.5em"},select:function(t,r){o(function(){if(r.node.isFolder()){var t=r.node.children;r.node.isSelected()?t.forEach(function(t){t.data.key=t.key,e.addLayer(t.data),n.addLayerLegend(t)}):t.forEach(function(t){t.data.key=t.key,e.removeLayer(t.data),n.removeLayerLegend(t)})}else r.node.isSelected()?(r.node.data.key=r.node.key,e.addLayer(r.node.data),n.addLayerLegend(r.node)):(r.node.data.key=r.node.key,e.removeLayer(r.node.data),n.removeLayerLegend(r.node))},1)},init:function(t,n){var o=e.map.getView().getZoom();o===parseInt(o,10)&&n.tree.visit(function(e){e.data.preselected&&e.setSelected(!0);var t=e.data.minZoom;e.data.maxZoom;e.isFolder()||void 0!=t&&(t<o?e.removeClass("layer-hidden"):e.addClass("layer-hidden"))})},click:function(t,n){if("icon"===n.targetType&&!n.node.isFolder()){var o=ol.proj.transformExtent(n.node.data.extent,ol.proj.get("EPSG:27493"),"EPSG:3857");e.map.getView().fit(o,{duration:1500})}}});r.tree=a.find("#tree").fancytree("getTree")}return{bindToController:!0,controller:"TabsController",controllerAs:"tc",link:r,restrict:"E",scope:{menuIsHidden:"="},templateUrl:"views/templates/tabs.html"}}angular.module("MapModule").directive("controlPanel",e),e.$inject=["MapService","LayersFactory","LegendsService","$timeout"]}(),function(){"use strict";function e(){function e(e,n){return t()}function t(){return new ol.style.Style({image:new ol.style.Circle({radius:4,fill:new ol.style.Fill({color:[24,72,26,.8]}),stroke:new ol.style.Stroke({color:[0,0,0,1]})})})}this.style=e}angular.module("MapModule").service("FeaturesStyle",e)}(),function(){"use strict";function e(){function e(e){$("#tree").fancytree("getTree").visit(function(t){t.isFolder()&&t.title==e.title&&e.children.forEach(function(e){e.extraClasses="protected",t.addChildren(e,0)})})}function t(){var e=[];$("#tree").fancytree("getTree").visit(function(t){!t.isFolder()&&t.data.protected&&e.push(t.key)});for(var t=0;t<e.length;t++){$("#tree").fancytree("getTree").getNodeByKey(e[t]).remove()}}return{glyph_opts:{map:{checkbox:"fa fa-toggle-off",checkboxSelected:"fa fa-toggle-on",checkboxUnknown:"fa fa-circle",doc:"fa fa-search",docOpen:"fa fa-search",error:"fa fa-exclamation-triangle",expanderClosed:"fa  fa-arrow-right",expanderLazy:"fa fa-arrow-right",expanderOpen:"fa fa-arrow-down",folder:"fa fa-folder",folderOpen:"fa fa-folder-open",loading:"fa fa-spinner"}},addLayer:e,removeProtectedLayers:t}}angular.module("MapModule").factory("LayersFactory",e)}(),function(){"use strict";function e(e,t,n){function o(e){proj4.defs("EPSG:27493","+proj=tmerc +lat_0=39.66666666666666 +lon_0=-8.131906111111112 +k=1 +x_0=180.598 +y_0=-86.98999999999999 +ellps=intl +towgs84=-223.237,110.193,36.649,0,0,0,0 +units=m +no_defs");var t=[-127101.82,-300782.39,160592.41,278542.12];ol.proj.get("EPSG:27493").setExtent(t),v=angular.extend(h,e),y=new ol.Map({target:v.target,layers:[new ol.layer.Tile({source:new ol.source.OSM({}),queryable:!1})],interactions:v.interactions,controls:v.controls,view:new ol.View({center:ol.proj.transform(v.center,"EPSG:4326","EPSG:3857"),zoom:v.zoom,minZoom:11})}),y.getView().on("change:resolution",function(e){var t=e.target.getZoom();t===parseInt(t,10)&&$("#tree").fancytree("getTree").visit(function(e){e.isFolder()||void 0!=e.data.minZoom&&(e.data.minZoom<t?e.removeClass("layer-hidden"):e.addClass("layer-hidden"))})})}function r(e){y.getLayers().setAt(0,e)}function a(e){"WMS"===e.type?s(e):"TileWMS"===e.type?i(e):p(e)}function i(t){if(d(t.key)){var n=new ol.layer.Tile({opacity:t.opacity,source:new ol.source.TileWMS({url:e.URL_WMS[e.ENVIRONMENT],params:{LAYERS:t.workspace+":"+t.name},extent:t.extent}),minResolution:f(t.maxZoom),maxResolution:f(t.minZoom),group:t.group,queryable:t.queryable});g[t.key]=n,y.getLayers().insertLayer(n),g[t.key].visible=!0}else g[t.key].visible||(y.getLayers().insertLayer(g[t.key]),g[t.key].visible=!0)}function s(t){if(d(t.key)){var n=new ol.layer.Image({opacity:t.opacity,source:new ol.source.ImageWMS({url:e.URL_WMS[e.ENVIRONMENT],params:{LAYERS:t.workspace+":"+t.name},extent:t.extent}),minResolution:f(t.maxZoom),maxResolution:f(t.minZoom),group:t.group,queryable:t.queryable});g[t.key]=n,y.getLayers().insertLayer(n),g[t.key].visible=!0}else g[t.key].visible||(y.getLayers().insertLayer(g[t.key]),g[t.key].visible=!0)}function l(e){g[e.key]&&(y.removeLayer(g[e.key]),g[e.key].visible=!1)}function c(){y.setView(new ol.View({center:ol.proj.transform(v.center,"EPSG:4326","EPSG:3857"),zoom:v.zoom,extent:[-928405.1144335504,5033494.2861691285,-777977.0427683234,5078592.132857382],minZoom:11}))}function u(e,t){var n=y.getView();window.view=n,y.getView().animate({center:ol.proj.transform(e,ol.proj.get(t),"EPSG:3857"),duration:1e3,zoom:16})}function d(e){return!g.hasOwnProperty(e)}function f(e){return void 0===e?e:Math.floor(156543.04/Math.pow(2,e))}function p(t){if(d(t.key)){var o=new ol.layer.Vector({source:new ol.source.Vector({loader:function(n){$.ajax(e.URL_WFS[e.ENVIRONMENT],{type:"GET",data:{service:"WFS",version:"1.1.1",request:"GetFeature",typename:t.workspace+":"+t.name,srsname:"EPSG:27493",outputFormat:"application/json",bbox:ol.proj.transformExtent(n,"EPSG:3857",ol.proj.get("EPSG:27493")).join(",")+","+ol.proj.get("EPSG:27493").getCode()},crossDomain:!0}).done(function(e){o.getSource().addFeatures((new ol.format.GeoJSON).readFeatures(e,{featureProjection:"EPSG:3857",dataProjection:ol.proj.get("EPSG:27493")}))})},strategy:ol.loadingstrategy.bbox}),style:n.style});g[t.key]=o,t.style&&(o.setStyle(new ol.style.Style(t.style)),o.setOpacity(t.opacity)),y.addLayer(o),g[t.key].visible=!0}else g[t.key].visible||(y.addLayer(g[t.key]),g[t.key].visible=!0)}var g={},m={};if(!ol)return{};var y={},h={zoom:12,target:"map",center:[-7.593569,41.595564],interactions:[new ol.interaction.MouseWheelZoom,new ol.interaction.DragPan],controls:[new ol.control.ScaleLine,new ol.control.OverviewMap({className:"ol-overviewmap ol-custom-overviewmap",layers:[new ol.layer.Image({source:new ol.source.ImageWMS({url:e.URL_WMS[e.ENVIRONMENT],params:{LAYERS:"unicer:limite"},extent:[43858.7242812507,208452.333204688,44110.6809999999,209084.351648437]})}),new ol.layer.Image({source:new ol.source.ImageWMS({url:e.URL_WMS[e.ENVIRONMENT],params:{LAYERS:"unicer:base"},extent:[43858.7242812507,208452.333204688,44110.6809999999,209084.351648437]})}),new ol.layer.Image({source:new ol.source.ImageWMS({url:e.URL_WMS[e.ENVIRONMENT],params:{LAYERS:"unicer:edificios"},extent:[43858.7242812507,208452.333204688,44110.6809999999,209084.351648437]})})],collapseLabel:"-",label:"+",collapsed:!0,tipLabel:""})]},v={};return angular.equals(y,{})&&o(),{map:y,init:o,addLayer:a,removeLayer:l,setDefaultView:c,userFeatures:m,setBaseLayer:r,zoomToCoordinate:u}}angular.module("MapModule").factory("MapService",e),e.$inject=["CONFIG","$http","FeaturesStyle"],ol.Collection.prototype.insertLayer=function(e){var t=this.getArray().findIndex(function(t){return t.get("group")<e.get("group")});-1!==t?this.insertAt(t,e):this.push(e)},ol.layer.Base.prototype.isQueryable=function(){return this.get("queryable")}}(),function(){"use strict";function e(e){function t(t,n,o){e.map.addControl(new ol.control.MousePosition({coordinateFormat:function(e){return ol.coordinate.format(e," {x} , {y} ",4)},projection:"EPSG:4326",className:"",target:document.getElementById("coordinate4326"),undefinedHTML:"&nbsp;"})),e.map.addControl(new ol.control.MousePosition({coordinateFormat:function(e){return ol.coordinate.format(e," {x} , {y} ",4)},projection:ol.proj.get("EPSG:27493"),className:"",target:document.getElementById("coordinate27493"),undefinedHTML:"&nbsp;"}))}return{bindToController:!0,controller:"MapInteractionsController",controllerAs:"itCtrl",link:t,restrict:"E",scope:{menuIsHidden:"="},templateUrl:"views/templates/interactions.html"}}angular.module("MapInteractionsModule").directive("mapInteractions",e),e.$inject=["MapService"]}(),function(){"use strict";function e(e,t){var n=this;!function(){n.results=[]}(),n.title="Resultados da Pesquisa",e.$watchCollection(function(){return t.getResults()},function(e){n.results=e}),n.hasResults=function(){return n.results.length>0}}angular.module("MapInteractionsModule").controller("LayerResultsController",e),e.$inject=["$scope","LayerQueryResultsService"]}(),function(){"use strict";function e(e,t){var n=this;!function(){e.get().then(function(e){n.locations=e.features}),n.location={}}(),n.onSelectCallback=function(e){t.zoomToCoordinate(e.geometry.coordinates,"EPSG:3857")}}angular.module("MapInteractionsModule").controller("LocationController",e),e.$inject=["LocationsService","MapService"]}(),function(){"use strict";function e(e,t,n,o){o.setMapInteraction("DragPan"),this.search=!1,this.isActive=function(e){return this.active==e},this.setDefaultView=function(e){n.setDefaultView()},this.setInteraction=function(e){o.setMapInteraction(e)},this.showMenu=function(){this.menuIsHidden=!1},this.showSearchBar=function(){this.search=!this.search},this.isSearch=function(){return!this.search},e.$watch(function(){return o.getMapInteraction()},function(t){e.itCtrl.active=t}),e.$watch("itCtrl.active",function(){e.itCtrl.currentInteraction=o.getText()}),e.$watch("itCtrl.menuIsHidden",function(){t(function(){n.map.updateSize()},10)})}angular.module("MapInteractionsModule").controller("MapInteractionsController",e),e.$inject=["$scope","$timeout","MapService","MapInteractionsService"]}(),function(){"use strict";function e(e){function t(t,n,a){a.forEach(function(a){if(a.isQueryable()){var i=a.getSource().getGetFeatureInfoUrl(ol.proj.transform(t.coordinate,"EPSG:3857",ol.proj.get("EPSG:27493")),n.getResolution(),ol.proj.get("EPSG:27493"),{INFO_FORMAT:"application/json"});if(i){o();new ol.format.GeoJSON;e({url:i}).then(function(e){e.data.features.length>0&&r.push(e.data)})}}})}function n(){return r}function o(){r.length=0}var r=[];this.getResults=n,this.getLayersInfo=t,this.clearResults=o}angular.module("MapInteractionsModule").service("LayerQueryResultsService",e),e.$inject=["$http"]}(),function(){"use strict";function e(e,t){function n(){var n=t.defer();return e({method:"GET",url:"/locations"}).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise}return{get:n}}angular.module("MapInteractionsModule").factory("LocationsService",e),e.$inject=["$http","$q"]}(),function(){"use strict";function e(e,t,n){var o={interaction:"",interactionText:""};this.setMapInteraction=function(n){switch(e.map.getInteractions().pop(),n){case"DragPan":o.interactionText="Mover Mapa",e.map.addInteraction(new ol.interaction.DragPan);break;case"ZoomIn":o.interactionText="Aproximar Mapa",e.map.addInteraction(new ol.interaction.Pointer({handleDownEvent:function(t){var n=e.map.getView();n.setCenter(t.coordinate),n.setZoom(n.getZoom()+1)}}));break;case"ZoomOut":o.interactionText="Afastar Mapa",e.map.addInteraction(new ol.interaction.Pointer({handleDownEvent:function(t){var n=e.map.getView();n.setCenter(t.coordinate),n.setZoom(n.getZoom()-1)}}));break;case"ZoomBox":o.interactionText="Fazer Zoom de Caixa",e.map.addInteraction(new ol.interaction.DragZoom({condition:ol.events.condition.always,className:"drag_zoom_box"}));break;case"Identify":o.interactionText="Identificar Camadas",e.map.addInteraction(new ol.interaction.Pointer({handleDownEvent:function(e){t.getLayersInfo(e,e.map.getView(),e.map.getLayers().getArray())}}))}o.interaction=n},this.getMapInteraction=function(){return o.interaction},this.getText=function(){return o.interactionText},this.setText=function(e){o.interactionText=e}}angular.module("MapInteractionsModule").service("MapInteractionsService",e),e.$inject=["MapService","LayerQueryResultsService","$http"]}(),function(){"use strict";function e(){return function(e){return angular.isNumber(e)?e:e?e.charAt(0).toUpperCase()+e.substr(1).toLowerCase():""}}angular.module("MapInteractionsModule").filter("capitalize",e)}(),function(){"use strict";angular.module("MapInteractionsModule").filter("propsFilter",function(){return function(e,t){var n=[];if(angular.isArray(e)){var o=Object.keys(t);e.forEach(function(e){for(var r=!1,a=0;a<o.length;a++){var i=o[a],s=t[i].toLowerCase();if(-1!==e[i].toString().toLowerCase().indexOf(s)){r=!0;break}}r&&n.push(e)})}else n=e;return n}})}();